<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-br">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${album.title}">Álbum</title>

    <link
            th:href="@{/css/base.css}"
            rel="stylesheet"
    />
    <link
            th:href="@{/css/components.css}"
            rel="stylesheet"
    />
    <link
        th:href="@{/css/pages/album.css}"
        rel="stylesheet"
    />
    <style>
        .star {
            font-size: 1.8rem;
            cursor: pointer;
            color: #ccc;
        }
        .star.active {
            color: #f5c518;
        }
    </style>

</head>

<body class="container py-4">

<a th:href="@{/}" class="btn btn-link mb-4">
    &larr; Voltar
</a>

<div class="row">
    <!-- Cover -->
    <div class="col-md-4 text-center">
        <div class="cover-wrapper mb-3 cover-sm" style="max-width: 300px;">
            <img
                    th:src="${album.coverUrl}"
                    class="img-fluid rounded shadow-sm mb-3"
                    alt="Capa do álbum"
                    style="max-width: 300px;"
            />
        </div>
    </div>

    <!-- Info -->
    <div class="col-md-8">
        <h2 th:text="${album.title}">Título</h2>

        <p class="text-muted">
            <strong th:text="${album.artist.name}">Artista</strong>
            • <span th:text="${album.releaseYear}">Ano</span>
        </p>

        <!-- Rating block
        <div class="mb-3">
            <span class="fs-3 fw-bold">
                ★ <span th:text="${album.}">0.0</span>
            </span>
            <span class="text-muted">
                (<span th:text="${stats.ratingCount}">0</span> avaliações)
            </span>
        </div>
        -->

        <hr/>

        <!-- Review form -->
        <h5 th:text="${myReview != null ? 'Editar review' : 'Escrever review'}">
            Escrever review
        </h5>

        <form id="reviewForm" class="mb-4">
            <input type="hidden" id="albumId" th:value="${album.id}"/>

            <div class="mb-2">
                <label class="form-label">Nota (0 a 5)</label>
                <div class="mb-2">
                    <label class="form-label">Nota</label>
                    <div id="stars"></div>
                    <input type="hidden" id="rating" value="4">
                </div>
            </div>

            <div class="mb-2">
                <label class="form-label">Texto</label>
                <textarea
                        class="form-control"
                        id="text"
                        rows="4"
                        placeholder="O que você achou?"
                        th:text="${myReview != null ? myReview.text : ''}"
                ></textarea>
            </div>

            <button class="btn btn-success" type="submit">
                Salvar review
            </button>

            <div class="mt-2 text-muted" id="status"></div>
        </form>

        <hr/>

        <!-- Reviews -->
        <h5>Reviews recentes</h5>
        <ul id="reviews" class="list-group"></ul>
    </div>
</div>

<script>
    async function loadReviews() {
        const albumId = document.getElementById('albumId').value;

        const res = await fetch(`/api/reviews?albumId=${albumId}`);
        const data = await res.json();

        const ul = document.getElementById('reviews');
        ul.innerHTML = '';

        data.forEach(r => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex gap-3';

            if (r.mine) li.classList.add('border-success');

            li.innerHTML = `
            <img src="${r.avatarUrl}" class="rounded-circle" width="40" height="40"/>
            <div>
                <strong>${r.username}</strong>
                ${r.mine ? '<span class="badge bg-success ms-2">You</span>' : ''}
                <div class="text-warning">${renderStars(r.rating)}</div>
                <div>${r.text ?? ''}</div>
            </div>
        `;

            ul.appendChild(li);
        });
    }

    document.getElementById('reviewForm')
        .addEventListener('submit', async (e) => {
            e.preventDefault();

            const body = {
                albumId: Number(document.getElementById('albumId').value),
                rating: Number(document.getElementById('rating').value),
                text: document.getElementById('text').value
            };

            const res = await fetch('/api/reviews', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            document.getElementById('status').textContent =
                res.ok ? 'Review salva!' : 'Erro ao salvar';

            await loadReviews();
        });

    loadReviews();

    const starsDiv = document.getElementById('stars');
    const ratingInput = document.getElementById('rating')

    function renderStars(value = 0) {
        let html = '';
        for (let i = 1; i <= 5; i++) {
            html += `<span class="star ${i <= value ? 'active' : ''}" data-value="${i}">★</span>`;
        }
        return html;
    }

    starsDiv.innerHTML = renderStars(4);

    starsDiv.addEventListener('click', e => {
        if (!e.target.classList.contains('star')) return;

        const value = Number(e.target.dataset.value);
        ratingInput.value = value;
        starsDiv.innerHTML = renderStars(value);
    });
</script>

</body>
</html>
